<!doctype html>
<html>
  <head>
    <title>WS Bridge Test</title>
    <style>
      body {
        font-family: system-ui;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .connected {
        background: #d4edda;
        color: #155724;
      }
      .disconnected {
        background: #f8d7da;
        color: #721c24;
      }
      .connecting {
        background: #fff3cd;
        color: #856404;
      }
      #log {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 13px;
        max-height: 400px;
        overflow-y: auto;
      }
      .log-entry {
        margin: 2px 0;
      }
      .log-in {
        color: #4ec9b0;
      }
      .log-out {
        color: #ce9178;
      }
      .log-error {
        color: #f14c4c;
      }
      .log-info {
        color: #9cdcfe;
      }
      button {
        padding: 8px 16px;
        margin: 5px;
        cursor: pointer;
      }
      input {
        padding: 8px;
        width: 200px;
      }
    </style>
  </head>
  <body>
    <h1>üîå WebSocket Bridge Tester</h1>

    <div>
      <label>Bridge URL: </label>
      <input type="text" id="wsUrl" value="ws://localhost:8080" />
      <button onclick="connect()">Connect</button>
      <button onclick="disconnect()">Disconnect</button>
    </div>

    <div id="statusBox" class="status disconnected">Status: Disconnected</div>

    <h3>Device Management</h3>
    <div>
      <input type="text" id="deviceIp" placeholder="192.168.x.x" />
      <button onclick="addDevice()">Add Device</button>
      <button onclick="removeDevice()">Remove Device</button>
    </div>

    <h3>Send Test Message</h3>
    <div>
      <button onclick="sendGetStatus()">Get Status (to all)</button>
      <button onclick="sendHeartbeat()">Heartbeat</button>
      <button onclick="sendGameStart()">Start Game</button>
      <button onclick="sendGameStop()">Stop Game</button>
    </div>

    <h3>Log</h3>
    <div id="log"></div>
    <button onclick="clearLog()">Clear Log</button>

    <script>
      let ws = null

      function log(msg, type = 'info') {
        const logDiv = document.getElementById('log')
        const entry = document.createElement('div')
        entry.className = `log-entry log-${type}`
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`
        logDiv.appendChild(entry)
        logDiv.scrollTop = logDiv.scrollHeight
      }

      function clearLog() {
        document.getElementById('log').innerHTML = ''
      }

      function updateStatus(state) {
        const box = document.getElementById('statusBox')
        box.className = `status ${state}`
        box.textContent = `Status: ${state.charAt(0).toUpperCase() + state.slice(1)}`
      }

      function connect() {
        const url = document.getElementById('wsUrl').value
        log(`Connecting to ${url}...`, 'info')
        updateStatus('connecting')

        try {
          ws = new WebSocket(url)

          ws.onopen = () => {
            log('‚úÖ Connected to bridge!', 'info')
            updateStatus('connected')
          }

          ws.onclose = (e) => {
            log(`‚ùå Disconnected (code: ${e.code})`, 'error')
            updateStatus('disconnected')
            ws = null
          }

          ws.onerror = (e) => {
            log('‚ùå WebSocket error', 'error')
          }

          ws.onmessage = (e) => {
            log(`‚¨ÖÔ∏è ${e.data}`, 'in')
            try {
              const msg = JSON.parse(e.data)
              if (msg.type === 'device_list') {
                log(`   Devices: ${JSON.stringify(msg.devices)}`, 'info')
              } else if (msg.source) {
                log(`   From device ${msg.source}: ${msg.payload?.type || 'unknown'}`, 'info')
              }
            } catch (err) {}
          }
        } catch (err) {
          log(`‚ùå Error: ${err.message}`, 'error')
          updateStatus('disconnected')
        }
      }

      function disconnect() {
        if (ws) {
          ws.close()
          ws = null
        }
      }

      function send(data) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          log('‚ùå Not connected!', 'error')
          return
        }
        const json = JSON.stringify(data)
        log(`‚û°Ô∏è ${json}`, 'out')
        ws.send(json)
      }

      function addDevice() {
        const ip = document.getElementById('deviceIp').value
        if (!ip) {
          log('Enter device IP first', 'error')
          return
        }
        send({ type: 'add_device', ip })
      }

      function removeDevice() {
        const ip = document.getElementById('deviceIp').value
        if (!ip) {
          log('Enter device IP first', 'error')
          return
        }
        send({ type: 'remove_device', ip })
      }

      function sendGetStatus() {
        send({ broadcast: true, payload: { op: 1, type: 'get_status' } })
      }

      function sendHeartbeat() {
        send({ broadcast: true, payload: { op: 2, type: 'heartbeat' } })
      }

      function sendGameStart() {
        send({ broadcast: true, payload: { op: 4, type: 'game_command', command: 1 } })
      }

      function sendGameStop() {
        send({ broadcast: true, payload: { op: 4, type: 'game_command', command: 0 } })
      }

      // Auto-connect on load
      log('Ready. Click Connect to test the bridge.', 'info')
    </script>
  </body>
</html>
